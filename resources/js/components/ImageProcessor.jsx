import { useState, useEffect } from "react";
import axios from "axios";
import PosToggler from "./PosToggler";
import PrimaryButton from "./PrimaryButton";
import RangeBox from "./RangeBox";

export default function ImageProcessor({ design }) {
    const [settings, setSettings] = useState({
        threshold: 128,
        contrast: 50,
        invert: false,
        despeckle: 0.1
    });

    const update = (key, val) => {
        setSettings(prev => ({ ...prev, [key]: val }));
    };

    useEffect(() => {
        if (design?.settings) {
            setSettings(prev => ({ ...prev, ...design.settings }));
        }
    }, [design]);

    useEffect(() => {
        if (!design?.id) return;
        const timer = setTimeout(() => {
            axios.put(`/designs/${design.id}`, settings).catch(console.error);
        }, 500);
        return () => clearTimeout(timer);
    }, [settings, design]);
    return (
        <>
            <div className="bg-[#171616] py-5 px-3 mx-4 rounded-[30px] max-w-[307px] w-full">
                <div className=" flex flex-col">
                    <h3 className="text-xl text-[#FFFFFF] font-semibold">Image Pre-Processing</h3>
                    <RangeBox value={settings.threshold} onChange={(v) => update('threshold', v)} title="Threshold" min={0} max={255} step={1} svg={<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 22 22" fill="none">
                        <path d="M3 3.5L3 18.5L19 18.5" stroke="#FEFEFE" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M5 14.2536C7.07364 4.99511 10.0265 16.2678 10.7034 14.2536C11.7405 11.1674 11.8237 7.88809 13.2969 4.37788C14.3332 1.90895 17.4444 4.99511 19 9.31574" stroke="#FEFEFE" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>} className="mt-4" />
                    <RangeBox value={settings.contrast} onChange={(v) => update('contrast', v)} title="Contrast" min={0} max={100} step={1} svg={<svg xmlns="http://www.w3.org/2000/svg" width="23" height="22" viewBox="0 0 23 22" fill="none">
                        <path d="M20 11.125C20 15.7504 16.2504 19.5 11.625 19.5C6.99962 19.5 3.25 15.7504 3.25 11.125C3.25 6.49962 6.99962 2.75 11.625 2.75C16.2504 2.75 20 6.49962 20 11.125Z" stroke="#FEFEFE" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M6.04199 11.125C6.04199 14.2086 8.54173 16.7083 11.6253 16.7083V5.54166C8.54173 5.54166 6.04199 8.0414 6.04199 11.125Z" stroke="#FEFEFE" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>} className="mt-5" />
                    <PosToggler checked={settings.invert} onChange={(v) => update('invert', v)} text="Invert Colors" className="mt-6" />
                    <div className="mt-10.5">
                        <h3 className="text-xl text-[#FFFFFF] font-semibold">Tracing Options</h3>
                        <RangeBox value={settings.despeckle} onChange={(v) => update('despeckle', v)} title="Despeckle Level" min={0.1} max={10} step={0.1} svg={<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 22 22" fill="none">
                            <path d="M5.1249 3.5C4.90239 3.5 4.68489 3.56598 4.49988 3.6896C4.31488 3.81321 4.17068 3.98891 4.08553 4.19448C4.00038 4.40005 3.97811 4.62625 4.02151 4.84448C4.06492 5.06271 4.17207 5.26316 4.3294 5.4205C4.48674 5.57783 4.68719 5.68498 4.90542 5.72838C5.12365 5.77179 5.34985 5.74951 5.55542 5.66437C5.76098 5.57922 5.93668 5.43502 6.0603 5.25002C6.18392 5.06501 6.2499 4.8475 6.2499 4.625C6.24956 4.32674 6.13092 4.04079 5.92002 3.82988C5.70911 3.61898 5.42316 3.50034 5.1249 3.5ZM11.4999 3.5C11.2774 3.5 11.0599 3.56598 10.8749 3.6896C10.6899 3.81321 10.5457 3.98891 10.4605 4.19448C10.3754 4.40005 10.3531 4.62625 10.3965 4.84448C10.4399 5.06271 10.5471 5.26316 10.7044 5.4205C10.8617 5.57783 11.0622 5.68498 11.2804 5.72838C11.4986 5.77179 11.7248 5.74951 11.9304 5.66437C12.136 5.57922 12.3117 5.43502 12.4353 5.25002C12.5589 5.06501 12.6249 4.8475 12.6249 4.625C12.6246 4.32674 12.5059 4.04079 12.295 3.82988C12.0841 3.61898 11.7982 3.50034 11.4999 3.5ZM17.8749 5.75C18.0974 5.75 18.3149 5.68402 18.4999 5.5604C18.6849 5.43679 18.8291 5.26109 18.9143 5.05552C18.9994 4.84995 19.0217 4.62375 18.9783 4.40552C18.9349 4.1873 18.8277 3.98684 18.6704 3.82951C18.5131 3.67217 18.3126 3.56503 18.0944 3.52162C17.8761 3.47821 17.6499 3.50049 17.4444 3.58564C17.2388 3.67078 17.0631 3.81498 16.9395 3.99998C16.8159 4.18499 16.7499 4.4025 16.7499 4.625C16.7502 4.92326 16.8689 5.20921 17.0798 5.42012C17.2907 5.63102 17.5766 5.74966 17.8749 5.75ZM5.1249 16.25C4.90239 16.25 4.68489 16.316 4.49988 16.4396C4.31488 16.5632 4.17068 16.7389 4.08553 16.9445C4.00038 17.15 3.97811 17.3762 4.02151 17.5945C4.06492 17.8127 4.17207 18.0132 4.3294 18.1705C4.48674 18.3278 4.68719 18.435 4.90542 18.4784C5.12365 18.5218 5.34985 18.4995 5.55542 18.4144C5.76098 18.3292 5.93668 18.185 6.0603 18C6.18392 17.815 6.2499 17.5975 6.2499 17.375C6.24956 17.0767 6.13092 16.7908 5.92002 16.5799C5.70911 16.369 5.42316 16.2503 5.1249 16.25ZM11.4999 16.25C11.2774 16.25 11.0599 16.316 10.8749 16.4396C10.6899 16.5632 10.5457 16.7389 10.4605 16.9445C10.3754 17.15 10.3531 17.3762 10.3965 17.5945C10.4399 17.8127 10.5471 18.0132 10.7044 18.1705C10.8617 18.3278 11.0622 18.435 11.2804 18.4784C11.4986 18.5218 11.7248 18.4995 11.9304 18.4144C12.136 18.3292 12.3117 18.185 12.4353 18C12.5589 17.815 12.6249 17.5975 12.6249 17.375C12.6246 17.0767 12.5059 16.7908 12.295 16.5799C12.0841 16.369 11.7982 16.2503 11.4999 16.25ZM17.8749 16.25C17.6524 16.25 17.4349 16.316 17.2499 16.4396C17.0649 16.5632 16.9207 16.7389 16.8355 16.9445C16.7504 17.15 16.7281 17.3762 16.7715 17.5945C16.8149 17.8127 16.9221 18.0132 17.0794 18.1705C17.2367 18.3278 17.4372 18.435 17.6554 18.4784C17.8736 18.5218 18.0998 18.4995 18.3054 18.4144C18.511 18.3292 18.6867 18.185 18.8103 18C18.9339 17.815 18.9999 17.5975 18.9999 17.375C18.9996 17.0767 18.8809 16.7908 18.67 16.5799C18.4591 16.369 18.1732 16.2503 17.8749 16.25ZM5.1249 9.875C4.90239 9.875 4.68489 9.94098 4.49988 10.0646C4.31488 10.1882 4.17068 10.3639 4.08553 10.5695C4.00038 10.775 3.97811 11.0012 4.02151 11.2195C4.06492 11.4377 4.17207 11.6382 4.3294 11.7955C4.48674 11.9528 4.68719 12.06 4.90542 12.1034C5.12365 12.1468 5.34985 12.1245 5.55542 12.0394C5.76098 11.9542 5.93668 11.81 6.0603 11.625C6.18392 11.44 6.2499 11.2225 6.2499 11C6.24956 10.7017 6.13092 10.4158 5.92002 10.2049C5.70911 9.99398 5.42316 9.87534 5.1249 9.875ZM11.4999 9.875C11.2774 9.875 11.0599 9.94098 10.8749 10.0646C10.6899 10.1882 10.5457 10.3639 10.4605 10.5695C10.3754 10.775 10.3531 11.0012 10.3965 11.2195C10.4399 11.4377 10.5471 11.6382 10.7044 11.7955C10.8617 11.9528 11.0622 12.06 11.2804 12.1034C11.4986 12.1468 11.7248 12.1245 11.9304 12.0394C12.136 11.9542 12.3117 11.81 12.4353 11.625C12.5589 11.44 12.6249 11.2225 12.6249 11C12.6246 10.7017 12.5059 10.4158 12.295 10.2049C12.0841 9.99398 11.7982 9.87534 11.4999 9.875ZM17.8749 9.875C17.6524 9.875 17.4349 9.94098 17.2499 10.0646C17.0649 10.1882 16.9207 10.3639 16.8355 10.5695C16.7504 10.775 16.7281 11.0012 16.7715 11.2195C16.8149 11.4377 16.9221 11.6382 17.0794 11.7955C17.2367 11.9528 17.4372 12.06 17.6554 12.1034C17.8736 12.1468 18.0998 12.1245 18.3054 12.0394C18.511 11.9542 18.6867 11.81 18.8103 11.625C18.9339 11.44 18.9999 11.2225 18.9999 11C18.9996 10.7017 18.8809 10.4158 18.67 10.2049C18.4591 9.99398 18.1732 9.87534 17.8749 9.875Z" fill="#FEFEFE" />
                            <path d="M6.2499 17.375C6.2496 17.114 6.15902 16.8622 5.99501 16.6621L5.92002 16.5799C5.70911 16.369 5.42316 16.2503 5.1249 16.25C4.90239 16.25 4.68489 16.316 4.49988 16.4396L4.36904 16.542C4.24657 16.6531 4.14937 16.7905 4.08553 16.9445L4.0331 17.1025C3.99307 17.263 3.98899 17.431 4.02151 17.5945C4.06492 17.8127 4.17207 18.0132 4.3294 18.1705C4.48674 18.3278 4.68719 18.435 4.90542 18.4784C5.06891 18.5109 5.23695 18.5068 5.39736 18.4668L5.55542 18.4144C5.70944 18.3505 5.84678 18.2533 5.9579 18.1309L6.0603 18C6.18392 17.815 6.2499 17.5975 6.2499 17.375ZM12.6249 17.375C12.6246 17.114 12.534 16.8622 12.37 16.6621L12.295 16.5799C12.0841 16.369 11.7982 16.2503 11.4999 16.25C11.2774 16.25 11.0599 16.316 10.8749 16.4396L10.744 16.542C10.6216 16.6531 10.5244 16.7905 10.4605 16.9445L10.4081 17.1025C10.3681 17.263 10.364 17.431 10.3965 17.5945C10.4399 17.8127 10.5471 18.0132 10.7044 18.1705C10.8617 18.3278 11.0622 18.435 11.2804 18.4784C11.4439 18.5109 11.6119 18.5068 11.7724 18.4668L11.9304 18.4144C12.0844 18.3505 12.2218 18.2533 12.3329 18.1309L12.4353 18C12.5589 17.815 12.6249 17.5975 12.6249 17.375ZM18.9999 17.375C18.9996 17.114 18.909 16.8622 18.745 16.6621L18.67 16.5799C18.4591 16.369 18.1732 16.2503 17.8749 16.25C17.6524 16.25 17.4349 16.316 17.2499 16.4396L17.119 16.542C16.9966 16.6531 16.8994 16.7905 16.8355 16.9445L16.7831 17.1025C16.7431 17.263 16.739 17.431 16.7715 17.5945C16.8149 17.8127 16.9221 18.0132 17.0794 18.1705C17.2367 18.3278 17.4372 18.435 17.6554 18.4784C17.8189 18.5109 17.9869 18.5068 18.1474 18.4668L18.3054 18.4144C18.4594 18.3505 18.5968 18.2533 18.7079 18.1309L18.8103 18C18.9339 17.815 18.9999 17.5975 18.9999 17.375ZM6.2499 11C6.2496 10.739 6.15902 10.4872 5.99501 10.2871L5.92002 10.2049C5.70911 9.99398 5.42316 9.87534 5.1249 9.875C4.90239 9.875 4.68489 9.94098 4.49988 10.0646L4.36904 10.167C4.24657 10.2781 4.14937 10.4155 4.08553 10.5695L4.0331 10.7275C3.99307 10.888 3.98899 11.056 4.02151 11.2195C4.06492 11.4377 4.17207 11.6382 4.3294 11.7955C4.48674 11.9528 4.68719 12.06 4.90542 12.1034C5.06891 12.1359 5.23695 12.1318 5.39736 12.0918L5.55542 12.0394C5.70944 11.9755 5.84678 11.8783 5.9579 11.7559L6.0603 11.625C6.18392 11.44 6.2499 11.2225 6.2499 11ZM12.6249 11C12.6246 10.739 12.534 10.4872 12.37 10.2871L12.295 10.2049C12.0841 9.99398 11.7982 9.87534 11.4999 9.875C11.2774 9.875 11.0599 9.94098 10.8749 10.0646L10.744 10.167C10.6216 10.2781 10.5244 10.4155 10.4605 10.5695L10.4081 10.7275C10.3681 10.888 10.364 11.056 10.3965 11.2195C10.4399 11.4377 10.5471 11.6382 10.7044 11.7955C10.8617 11.9528 11.0622 12.06 11.2804 12.1034C11.4439 12.1359 11.6119 12.1318 11.7724 12.0918L11.9304 12.0394C12.0844 11.9755 12.2218 11.8783 12.3329 11.7559L12.4353 11.625C12.5589 11.44 12.6249 11.2225 12.6249 11ZM18.9999 11C18.9996 10.739 18.909 10.4872 18.745 10.2871L18.67 10.2049C18.4591 9.99398 18.1732 9.87534 17.8749 9.875C17.6524 9.875 17.4349 9.94098 17.2499 10.0646L17.119 10.167C16.9966 10.2781 16.8994 10.4155 16.8355 10.5695L16.7831 10.7275C16.7431 10.888 16.739 11.056 16.7715 11.2195C16.8149 11.4377 16.9221 11.6382 17.0794 11.7955C17.2367 11.9528 17.4372 12.06 17.6554 12.1034C17.8189 12.1359 17.9869 12.1318 18.1474 12.0918L18.3054 12.0394C18.4594 11.9755 18.5968 11.8783 18.7079 11.7559L18.8103 11.625C18.9339 11.44 18.9999 11.2225 18.9999 11ZM17.2528 3.12402C17.5498 3.00103 17.8771 2.96855 18.1923 3.03125C18.5074 3.094 18.7971 3.24841 19.0243 3.47559C19.2515 3.70276 19.4059 3.99253 19.4686 4.30762C19.5313 4.62284 19.4989 4.95014 19.3759 5.24707C19.2529 5.54387 19.0444 5.79806 18.7772 5.97656C18.5101 6.1549 18.1961 6.25 17.8749 6.25C17.4444 6.2494 17.0309 6.07787 16.7265 5.77344C16.422 5.469 16.2505 5.0565 16.2499 4.62598L16.2548 4.50488C16.2755 4.226 16.3673 3.95635 16.5233 3.72266C16.7018 3.45551 16.956 3.24703 17.2528 3.12402ZM6.2499 4.625C6.2496 4.36401 6.15902 4.11221 5.99501 3.91211L5.92002 3.82988C5.70911 3.61898 5.42316 3.50034 5.1249 3.5C4.90239 3.5 4.68489 3.56598 4.49988 3.6896L4.36904 3.79199C4.24657 3.90312 4.14937 4.04046 4.08553 4.19448L4.0331 4.35254C3.99307 4.51295 3.98899 4.68099 4.02151 4.84448C4.06492 5.06271 4.17207 5.26316 4.3294 5.4205C4.48674 5.57783 4.68719 5.68498 4.90542 5.72838C5.06891 5.7609 5.23695 5.75683 5.39736 5.7168L5.55542 5.66437C5.70944 5.60053 5.84678 5.50332 5.9579 5.38086L6.0603 5.25002C6.18392 5.06501 6.2499 4.8475 6.2499 4.625ZM12.6249 4.625C12.6246 4.36401 12.534 4.11221 12.37 3.91211L12.295 3.82988C12.0841 3.61898 11.7982 3.50034 11.4999 3.5C11.2774 3.5 11.0599 3.56598 10.8749 3.6896L10.744 3.79199C10.6216 3.90312 10.5244 4.04046 10.4605 4.19448L10.4081 4.35254C10.3681 4.51295 10.364 4.68099 10.3965 4.84448C10.4399 5.06271 10.5471 5.26316 10.7044 5.4205C10.8617 5.57783 11.0622 5.68498 11.2804 5.72838C11.4439 5.7609 11.6119 5.75683 11.7724 5.7168L11.9304 5.66437C12.0844 5.60053 12.2218 5.50332 12.3329 5.38086L12.4353 5.25002C12.5589 5.06501 12.6249 4.8475 12.6249 4.625ZM18.0944 3.52162C17.8761 3.47821 17.6499 3.50049 17.4444 3.58564L17.2958 3.66016C17.1539 3.74529 17.0322 3.8613 16.9395 3.99998L16.8573 4.14453C16.7867 4.29411 16.7499 4.45822 16.7499 4.625C16.7502 4.92326 16.8689 5.20921 17.0798 5.42012C17.2907 5.63102 17.5766 5.74966 17.8749 5.75C18.0417 5.75 18.2058 5.71321 18.3554 5.64258L18.4999 5.5604C18.6386 5.46774 18.7546 5.34595 18.8397 5.2041L18.9143 5.05552C18.9781 4.90137 19.007 4.7356 18.9989 4.57031L18.9783 4.40552C18.9457 4.24199 18.8776 4.08797 18.7792 3.95508L18.6704 3.82951C18.5525 3.71157 18.4105 3.62126 18.2548 3.56543L18.0944 3.52162ZM6.74501 17.4951C6.72434 17.774 6.63248 18.0436 6.47646 18.2773C6.29796 18.5445 6.04377 18.753 5.74697 18.876C5.45004 18.999 5.12273 19.0315 4.80751 18.9688C4.49243 18.906 4.20266 18.7516 3.97548 18.5244C3.74831 18.2972 3.59389 18.0075 3.53115 17.6924C3.46845 17.3772 3.50093 17.0499 3.62392 16.7529C3.74693 16.4561 3.95541 16.2019 4.22255 16.0234C4.48967 15.8451 4.80371 15.75 5.1249 15.75C5.55542 15.7506 5.9689 15.9221 6.27333 16.2266C6.57777 16.531 6.7493 16.9435 6.7499 17.374L6.74501 17.4951ZM13.12 17.4951C13.0993 17.774 13.0075 18.0436 12.8515 18.2773C12.673 18.5445 12.4188 18.753 12.122 18.876C11.825 18.999 11.4977 19.0315 11.1825 18.9688C10.8674 18.906 10.5777 18.7516 10.3505 18.5244C10.1233 18.2972 9.96889 18.0075 9.90615 17.6924C9.84345 17.3772 9.87593 17.0499 9.99892 16.7529C10.1219 16.4561 10.3304 16.2019 10.5976 16.0234C10.8647 15.8451 11.1787 15.75 11.4999 15.75C11.9304 15.7506 12.3439 15.9221 12.6483 16.2266C12.9528 16.531 13.1243 16.9435 13.1249 17.374L13.12 17.4951ZM19.4999 17.375C19.4999 17.6962 19.4048 18.0102 19.2265 18.2773C19.048 18.5445 18.7938 18.753 18.497 18.876C18.2 18.999 17.8727 19.0315 17.5575 18.9688C17.2424 18.906 16.9527 18.7516 16.7255 18.5244C16.4983 18.2972 16.3439 18.0075 16.2811 17.6924C16.2184 17.3772 16.2509 17.0499 16.3739 16.7529C16.4969 16.4561 16.7054 16.2019 16.9726 16.0234C17.2397 15.8451 17.5537 15.75 17.8749 15.75C18.3054 15.7506 18.7189 15.9221 19.0233 16.2266C19.3278 16.531 19.4993 16.9445 19.4999 17.375ZM6.7499 11C6.7499 11.3212 6.6548 11.6352 6.47646 11.9023C6.29796 12.1695 6.04377 12.378 5.74697 12.501C5.45004 12.624 5.12273 12.6565 4.80751 12.5938C4.49243 12.531 4.20266 12.3766 3.97548 12.1494C3.74831 11.9222 3.59389 11.6325 3.53115 11.3174C3.46845 11.0022 3.50093 10.6749 3.62392 10.3779C3.74693 10.0811 3.95541 9.82694 4.22255 9.64844C4.48967 9.4701 4.80371 9.375 5.1249 9.375C5.55542 9.3756 5.9689 9.54713 6.27333 9.85156C6.57777 10.156 6.7493 10.5695 6.7499 11ZM13.1249 11C13.1249 11.3212 13.0298 11.6352 12.8515 11.9023C12.673 12.1695 12.4188 12.378 12.122 12.501C11.825 12.624 11.4977 12.6565 11.1825 12.5938C10.8674 12.531 10.5777 12.3766 10.3505 12.1494C10.1233 11.9222 9.96889 11.6325 9.90615 11.3174C9.84345 11.0022 9.87593 10.6749 9.99892 10.3779C10.1219 10.0811 10.3304 9.82694 10.5976 9.64844C10.8647 9.4701 11.1787 9.375 11.4999 9.375C11.9304 9.3756 12.3439 9.54713 12.6483 9.85156C12.9528 10.156 13.1243 10.5695 13.1249 11ZM19.4999 11C19.4999 11.3212 19.4048 11.6352 19.2265 11.9023C19.048 12.1695 18.7938 12.378 18.497 12.501C18.2 12.624 17.8727 12.6565 17.5575 12.5938C17.2424 12.531 16.9527 12.3766 16.7255 12.1494C16.4983 11.9222 16.3439 11.6325 16.2811 11.3174C16.2184 11.0022 16.2509 10.6749 16.3739 10.3779C16.4969 10.0811 16.7054 9.82694 16.9726 9.64844C17.2397 9.4701 17.5537 9.375 17.8749 9.375C18.3054 9.3756 18.7189 9.54713 19.0233 9.85156C19.3278 10.156 19.4993 10.5695 19.4999 11ZM6.7499 4.625C6.7499 4.94619 6.6548 5.26022 6.47646 5.52734C6.29796 5.79449 6.04377 6.00297 5.74697 6.12598C5.45004 6.24897 5.12273 6.28145 4.80751 6.21875C4.49243 6.156 4.20266 6.00159 3.97548 5.77441C3.74831 5.54724 3.59389 5.25747 3.53115 4.94238C3.46845 4.62716 3.50093 4.29986 3.62392 4.00293C3.74693 3.70613 3.95541 3.45194 4.22255 3.27344C4.48967 3.0951 4.80468 3 5.12587 3C5.5564 3.0006 5.9689 3.17213 6.27333 3.47656C6.57777 3.781 6.7493 4.19447 6.7499 4.625ZM13.1249 4.625C13.1249 4.94619 13.0298 5.26023 12.8515 5.52734C12.673 5.79449 12.4188 6.00297 12.122 6.12598C11.825 6.24897 11.4977 6.28145 11.1825 6.21875C10.8674 6.156 10.5777 6.00159 10.3505 5.77441C10.1233 5.54724 9.96889 5.25747 9.90615 4.94238C9.84345 4.62716 9.87593 4.29986 9.99892 4.00293C10.1219 3.70613 10.3304 3.45194 10.5976 3.27344C10.8647 3.0951 11.1797 3 11.5009 3C11.9314 3.0006 12.3439 3.17213 12.6483 3.47656C12.9528 3.781 13.1243 4.19447 13.1249 4.625Z" fill="#FEFEFE" />
                        </svg>} className="mt-4" />
                    </div>
                </div>
                <div className="flex justify-center mt-53">
                    <PrimaryButton text="Download SVG" className="w-full" />
                </div>
            </div>
        </>
    )
}